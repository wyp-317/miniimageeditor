# 进阶任务完成报告

## 整体设计
- 目标聚焦“四块能力”：手势（双指缩放、单指平移）、比例裁剪（自由/1:1/3:4/9:16）、撤销/重做（状态快照）、滤镜与调色（实时预览 + 一致导出）。
- 编辑器以 OpenGL ES 2.0 为核心渲染，使用 MVP 矩阵维护缩放与平移；裁剪叠层独立于渲染层，互不耦合。
- 新增“拼图”架构：选择页（系统相册导入背景 + 模式单选）→ 线性拼接/宫格合成 → 预览保存。

## 开发遇到的困难
- 手势手感：缩放时画面漂移、平移速度过慢或过快、双指缩放与单指平移同时存在的时序问题。
- 比例裁剪：角/边拖拽时保持宽高比，越界与最小尺寸的动态约束，比例切换后的居中与自适应。
- 撤销/重做：多源状态（缩放、平移、裁剪框）的一致性恢复与栈管理，防止重复入栈与误恢复。
- 滤镜与调色：选择在 GPU 实时预览与 CPU 导出保持效果一致，着色器公式与性能的权衡；UI 文本在不同字数下的完整可读性。
- 拼图：
  - 线性拼接的尺寸统一与对齐策略（居中、边对齐、间距）；
  - 宫格的中心裁剪与边界一致性；
  - 背景位图与前景图片的组合顺序与内存占用。

## 解决思路
- 手势：在 `EditorActivity` 针对 `ScaleGestureDetector` 取焦点坐标并投影到 NDC，渲染器提供“按焦点缩放”接口以同时修正平移；平移提高速度系数并在手势开始入栈，结束复位标志位。
- 比例裁剪：在 `CropOverlayView` 维护 `aspectRatio`，角/边拖拽分支强制比；`constrain()` 做最小尺寸与边界修正；切换比例时居中重算目标宽高，使交互连续。
- 撤销/重做：使用结构体快照保存 `scale/tx/ty/cropRect`，在手势或裁剪开始时入栈并清空重做栈；恢复时先取当前快照入到另一栈，再应用目标快照，保证状态一致与可逆。
- 滤镜与调色：
  - Shader 设计：片段着色器中增加 Uniform `uFilterMode/uBrightness/uContrast/uExposure`，先应用曝光与对比度再加亮度；根据模式做高亮提升、暗部饱和、暗光提亮或黑白。
  - 导出一致性：CPU 端 `BitmapUtils.applyEffects()` 按近似公式逐像素处理，使用 `smoothstep/mix` 的线性近似以保证接近预览效果，并在保存前裁剪位图。
  - 性能与体验：预览走 GPU 保持 60fps 交互，导出在 IO 协程执行，显示进度覆盖层；文本自适应与两行显示防止按钮文字截断。

### 拼图实现与算法细节
- 选择页：
  - `MaterialButtonToggleGroup` 单选保证状态清晰；“开始拼图”受图片与方式同时选择约束；
  - 系统照片选择器 `PickVisualMedia.ImageOnly` 限制类型，仅返回用户确认的图片；在返回后弹出缩放预览二次确认，避免误选。
- 横/竖拼：
  - 将所有图片按目标基准（2048）统一缩放：横拼统一高度、竖拼统一宽度；
  - 输出位图先绘制背景（如有），再按方向居中依次绘制前景；
  - 复杂度 O(n) 合成，按位图顺序迭代计算偏移。
- 宫格：
  - 输出固定为 2048×2048；单格大小为 2048/n；
  - 使用中心裁剪 + 缩放 `centerCropScale()` 保证不拉伸且铺满每格；
  - 栅格遍历绘制，保持行列对齐。
- 自由拼：
  - `TransformableImageView` 提供最小缩放（完整可见）与最大缩放边界、平移越界校正；
  - 背景素材通过对话选择或系统相册导入（选择页导入后在预览合成）。

### 性能与内存
- 输出分辨率统一为 2048 基准，兼顾移动端清晰度与内存占用（ARGB_8888 ~ 16MB 级别）。
- 背景与前景位图处理采用中心裁剪后缩放，减少超大位图直接绘制带来的临时分配。
- 选择页与预览页均避免多次解码同一 URI，优先使用流式一次解码与共享引用。
